---

- name: Download subject public key & add
  apt_key:
    url: https://bintray.com/user/downloadSubjectPublicKey?username=bintray
    state: present

- name: Add kontena.list
  copy:
    content: "deb http://dl.bintray.com/kontena/ubuntu {{ ansible_distribution_release }} main"
    dest: /etc/apt/sources.list.d/kontena.list

- name: Update apt cache
  apt:
    update_cache: yes

- name: Install Kontena Agent without interactive mode & postinstall script
  shell: >
    apt-get download kontena-agent \
    && dpkg --unpack kontena-agent*.deb \
    && rm -f /var/lib/dpkg/info/kontena-agent.postinst \
    && dpkg --configure kontena-agent \
    && apt-get install -yf

- name: Setup Master URI inside /etc/kontena-agent.env
  lineinfile:
    path: "{{ kontena_node_config_path }}"
    regexp: "^KONTENA_URI="
    line: "KONTENA_URI={{ kontena_node_master_uri }}"

- name: Setup Token inside /etc/kontena-agent.env
  lineinfile:
    path: "{{ kontena_node_config_path }}"
    regexp: "^KONTENA_TOKEN="
    line: "KONTENA_TOKEN={{ kontena_node_token }}"

- name: Restart Kontena Agent
  when: ansible_distribution_release == "xenial"
  systemd:
    name: kontena-agent
    daemon_reload: yes
    state: restarted

- name: Restart Kontena Agent
  when: ansible_distribution_release == "xenial"
  systemd:
    name: kontena-agent
    daemon_reload: yes
    state: restarted

- name: Restart Docker
  when: ansible_distribution_release == "trusty"
  service:
    name: docker
    state: restarted

- name: Restart Kontena Agent
  when: ansible_distribution_release == "trusty"
  service:
    name: kontena-agent
    state: restarted
